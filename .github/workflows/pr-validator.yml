name: PR Validator

on:
  pull_request:
    types: [opened, edited, reopened]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const prNumber = pr.number;
            const author = pr.user.login;

            // â”€â”€ Ensure all required labels exist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const ensureLabel = async (name, color, description) => {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name, color, description
                });
              } catch (e) { /* already exists â€” ignore */ }
            };

            await ensureLabel('invalid-pr',          'e11d48', 'PR is missing required information');
            await ensureLabel('needs-review',         '7c3aed', 'Valid issue-linked PR awaiting maintainer review');
            await ensureLabel('needs-admin-review',   'f59e0b', 'General improvement PR â€” admin must assign level before merging');
            await ensureLabel('level-1',              '22c55e', 'Beginner contribution (5 pts)');
            await ensureLabel('level-2',              'f97316', 'Intermediate contribution (20 pts)');

            // â”€â”€ Remove stale validation labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const removeLabel = async (label) => {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label
                });
              } catch (e) { /* wasn't applied â€” ignore */ }
            };

            await removeLabel('invalid-pr');
            await removeLabel('needs-review');
            await removeLabel('needs-admin-review');

            // â”€â”€ Check for team number  e.g. "Team 07", "team 3" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const teamMatch = body.match(/team\s*\d+/i);
            const hasTeamNumber = Boolean(teamMatch);
            const teamLabel = teamMatch
              ? teamMatch[0].replace(/\s+/g, ' ').trim()
              : null;

            // â”€â”€ Check for linked issue  e.g. "Closes #42" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const issueMatch = body.match(/(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#\d+/i);
            const hasLinkedIssue = Boolean(issueMatch);

            // â”€â”€ CASE 1: Missing team number â€” always invalid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (!hasTeamNumber) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['invalid-pr']
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## âš ï¸ PR Validation Failed

Hey @${author}! Your PR is missing a required field:

âŒ **Team Number missing** â€” Add your team number in the PR description.

**Example:**
\`\`\`
Team 07
\`\`\`

### How to fix:
1. Click the **pencil icon âœï¸** on your PR description
2. Add your team number anywhere in the description
3. Save â€” this check will run again automatically

> ðŸ“– See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) for full guidelines.
> ðŸš€ **GDG CHARUSAT Open Source Contri Sprintathon**`
              });
              return;
            }

            // â”€â”€ CASE 2: Has team number + linked issue â†’ standard PR â”€â”€â”€â”€â”€â”€â”€
            if (hasTeamNumber && hasLinkedIssue) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['needs-review']
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## âœ… PR Validation Passed

Hey @${author}! Your PR looks good. Here's what we found:

| | |
|---|---|
| ðŸ‘¥ **Team Number** | \`${teamLabel}\` |
| ðŸ”— **Linked Issue** | \`${issueMatch[0]}\` |

A maintainer will review your PR within **24â€“48 hours**. Stay responsive to feedback!

> ðŸš€ **GDG CHARUSAT Open Source Contri Sprintathon**`
              });
              return;
            }

            // â”€â”€ CASE 3: Has team number but NO linked issue â†’ general improvement PR â”€â”€
            if (hasTeamNumber && !hasLinkedIssue) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['needs-admin-review']
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ðŸ” General Improvement PR â€” Pending Admin Review

Hey @${author}! Your PR has been received as a **General Improvement PR** (no linked issue).

| | |
|---|---|
| ðŸ‘¥ **Team Number** | \`${teamLabel}\` |
| ðŸ”— **Linked Issue** | None |

**What happens next:**
1. ðŸ”Ž An admin will review your changes
2. ðŸ·ï¸ If approved, the admin will assign a level label (\`level-1\` or \`level-2]\`) based on the complexity of your contribution
3. â­ Points will be calculated automatically when the PR is merged

> â³ Please be patient â€” admin review may take longer than standard PRs.
> âš ï¸ PRs that are trivial or low quality may be closed without merging.
> ðŸ“– See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) for guidelines.
> ðŸš€ **GDG CHARUSAT Open Source Contri Sprintathon**`
              });
            }
